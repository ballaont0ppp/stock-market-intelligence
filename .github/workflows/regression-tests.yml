name: Regression Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run full regression suite daily at 2 AM
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - smoke
          - sanity
          - full
          - all

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.suite == 'smoke' || github.event.inputs.suite == 'all'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-json-report
      
      - name: Run smoke tests
        run: |
          python tests/test_smoke/run_smoke_tests.py
        timeout-minutes: 5
      
      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: smoke-test-results
          path: test_results/

  sanity-tests:
    name: Sanity Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.suite == 'sanity' || github.event.inputs.suite == 'all'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-json-report
      
      - name: Run sanity tests
        run: |
          python tests/test_sanity/run_sanity_tests.py
        timeout-minutes: 20
      
      - name: Upload sanity test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: sanity-test-results
          path: test_results/

  full-regression:
    name: Full Regression Tests
    runs-on: ubuntu-latest
    needs: sanity-tests
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-json-report
      
      - name: Run full regression suite
        run: |
          python run_all_regression_tests.py full --report
        timeout-minutes: 150
      
      - name: Upload regression test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: full-regression-results
          path: |
            test_results/
            htmlcov/
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./htmlcov/coverage.xml
          flags: regression
          name: regression-coverage

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, sanity-tests]
    if: always()
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all test results
        uses: actions/download-artifact@v3
        with:
          path: all-test-results
      
      - name: Generate summary report
        run: |
          echo "# Regression Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "all-test-results/smoke-test-results" ]; then
            echo "✓ Smoke tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "✗ Smoke tests failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "all-test-results/sanity-test-results" ]; then
            echo "✓ Sanity tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "✗ Sanity tests failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "all-test-results/full-regression-results" ]; then
            echo "✓ Full regression tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Full regression tests not run (scheduled only)" >> $GITHUB_STEP_SUMMARY
          fi
