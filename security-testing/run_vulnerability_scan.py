"""
OWASP ZAP Vulnerability Scanner
Performs comprehensive vulnerability assessment
"""
import time
import sys
from pathlib import Path

try:
    from zapv2 import ZAPv2
except ImportError:
    print("Error: python-owasp-zap-v2.4 not installed")
    print("Install with: pip install python-owasp-zap-v2.4")
    sys.exit(1)

from config import (
    APP_URL, ZAP_API_KEY, ZAP_PROXY_HOST, ZAP_PROXY_PORT,
    ZAP_TIMEOUT, REPORTS_DIR, RESULTS_DIR
)
from utils import SecurityTestResult, ReportGenerator, check_app_running


class VulnerabilityScanner:
    """OWASP ZAP vulnerability scanner"""
    
    def __init__(self):
        self.zap = ZAPv2(
            apikey=ZAP_API_KEY,
            proxies={
                'http': f'http://{ZAP_PROXY_HOST}:{ZAP_PROXY_PORT}',
                'https': f'http://{ZAP_PROXY_HOST}:{ZAP_PROXY_PORT}'
            }
        )
        self.target_url = APP_URL
        self.result = SecurityTestResult("Vulnerability Assessment")
    
    def check_zap_connection(self) -> bool:
        """Check if ZAP is running and accessible"""
        try:
            version = self.zap.core.version
            print(f"✓ Connected to OWASP ZAP version: {version}")
            return True
        except Exception as e:
            print(f"✗ Failed to connect to OWASP ZAP: {e}")
            print("\nPlease ensure OWASP ZAP is running in daemon mode:")
            print(f"  zap.sh -daemon -port {ZAP_PROXY_PORT} -config api.key={ZAP_API_KEY}")
            return False
    
    def spider_scan(self):
        """Perform spider scan to discover URLs"""
        print(f"\n[1/4] Starting spider scan on {self.target_url}...")
        
        scan_id = self.zap.spider.scan(self.target_url)
        
        # Wait for spider to complete
        while int(self.zap.spider.status(scan_id)) < 100:
            progress = int(self.zap.spider.status(scan_id))
            print(f"  Spider progress: {progress}%", end='\r')
            time.sleep(2)
        
        print(f"  Spider progress: 100%")
        
        # Get discovered URLs
        urls = self.zap.core.urls()
        print(f"✓ Spider scan complete. Discovered {len(urls)} URLs")
        
        return urls
    
    def ajax_spider_scan(self):
        """Perform AJAX spider scan for JavaScript-heavy pages"""
        print(f"\n[2/4] Starting AJAX spider scan...")
        
        try:
            scan_id = self.zap.ajaxSpider.scan(self.target_url)
            
            # Wait for AJAX spider to complete
            timeout = 300  # 5 minutes
            elapsed = 0
            while self.zap.ajaxSpider.status == 'running':
                if elapsed >= timeout:
                    print("  AJAX spider timeout, stopping...")
                    self.zap.ajaxSpider.stop()
                    break
                print(f"  AJAX spider running... ({elapsed}s)", end='\r')
                time.sleep(5)
                elapsed += 5
            
            results = self.zap.ajaxSpider.results()
            print(f"✓ AJAX spider complete. Found {len(results)} additional URLs")
        except Exception as e:
            print(f"  AJAX spider not available or failed: {e}")
    
    def active_scan(self):
        """Perform active vulnerability scan"""
        print(f"\n[3/4] Starting active scan (this may take several minutes)...")
        
        scan_id = self.zap.ascan.scan(self.target_url)
        
        # Wait for active scan to complete
        while int(self.zap.ascan.status(scan_id)) < 100:
            progress = int(self.zap.ascan.status(scan_id))
            print(f"  Active scan progress: {progress}%", end='\r')
            time.sleep(5)
        
        print(f"  Active scan progress: 100%")
        print("✓ Active scan complete")
    
    def passive_scan(self):
        """Wait for passive scan to complete"""
        print(f"\n[4/4] Waiting for passive scan to complete...")
        
        # Passive scan runs automatically, just wait for it to finish
        timeout = 60
        elapsed = 0
        while int(self.zap.pscan.records_to_scan) > 0:
            if elapsed >= timeout:
                break
            remaining = int(self.zap.pscan.records_to_scan)
            print(f"  Passive scan: {remaining} records remaining", end='\r')
            time.sleep(2)
            elapsed += 2
        
        print("✓ Passive scan complete")
    
    def collect_alerts(self):
        """Collect and process vulnerability alerts"""
        print("\nCollecting vulnerability alerts...")
        
        alerts = self.zap.core.alerts(baseurl=self.target_url)
        
        severity_map = {
            '3': 'high',
            '2': 'medium',
            '1': 'low',
            '0': 'info'
        }
        
        for alert in alerts:
            severity = severity_map.get(alert.get('risk', '0'), 'info')
            
            # Map to our severity levels (ZAP doesn't have 'critical')
            if severity == 'high' and alert.get('confidence') == '3':
                severity = 'critical'
            
            self.result.add_finding(
                severity=severity,
                title=alert.get('alert', 'Unknown'),
                description=alert.get('description', ''),
                recommendation=alert.get('solution', ''),
                evidence=f"URL: {alert.get('url', '')}\nParameter: {alert.get('param', '')}\nAttack: {alert.get('attack', '')}",
                cwe=f"CWE-{alert.get('cweid', 'N/A')}"
            )
        
        print(f"✓ Collected {len(alerts)} vulnerability alerts")
    
    def generate_zap_report(self):
        """Generate ZAP HTML report"""
        print("\nGenerating ZAP HTML report...")
        
        try:
            html_report = self.zap.core.htmlreport()
            report_path = REPORTS_DIR / 'zap_detailed_report.html'
            with open(report_path, 'w', encoding='utf-8') as f:
                f.write(html_report)
            print(f"✓ ZAP detailed report saved: {report_path}")
        except Exception as e:
            print(f"  Warning: Could not generate ZAP HTML report: {e}")
    
    def run_scan(self):
        """Run complete vulnerability scan"""
        start_time = time.time()
        
        print("=" * 70)
        print("OWASP ZAP Vulnerability Assessment")
        print("=" * 70)
        
        # Check ZAP connection
        if not self.check_zap_connection():
            self.result.set_status('failed')
            return self.result
        
        # Check if app is running
        if not check_app_running(self.target_url):
            print(f"\n✗ Application not accessible at {self.target_url}")
            print("Please ensure the application is running before scanning")
            self.result.set_status('failed')
            return self.result
        
        print(f"\n✓ Application accessible at {self.target_url}")
        
        try:
            # Run scans
            self.spider_scan()
            self.ajax_spider_scan()
            self.active_scan()
            self.passive_scan()
            
            # Collect results
            self.collect_alerts()
            
            # Generate ZAP report
            self.generate_zap_report()
            
            self.result.set_status('completed')
            
        except Exception as e:
            print(f"\n✗ Scan failed: {e}")
            self.result.set_status('failed')
            self.result.add_finding(
                severity='high',
                title='Scan Error',
                description=f'Vulnerability scan encountered an error: {str(e)}',
                recommendation='Review scan configuration and try again'
            )
        
        # Set duration
        duration = time.time() - start_time
        self.result.set_duration(duration)
        
        # Print summary
        print("\n" + "=" * 70)
        print("Scan Summary")
        print("=" * 70)
        print(f"Status: {self.result.status.upper()}")
        print(f"Duration: {duration:.2f}s")
        print(f"Total Findings: {self.result.summary['total']}")
        print(f"  Critical: {self.result.summary['critical']}")
        print(f"  High: {self.result.summary['high']}")
        print(f"  Medium: {self.result.summary['medium']}")
        print(f"  Low: {self.result.summary['low']}")
        print(f"  Info: {self.result.summary['info']}")
        
        return self.result


def main():
    """Main execution"""
    scanner = VulnerabilityScanner()
    result = scanner.run_scan()
    
    # Save results
    print("\nSaving results...")
    json_path = result.save_json('vulnerability_scan.json')
    print(f"✓ JSON results saved: {json_path}")
    
    # Generate report
    report_path = ReportGenerator.generate_report(result, 'vulnerability_report.html')
    print(f"✓ HTML report saved: {report_path}")
    
    print("\n" + "=" * 70)
    print("Vulnerability assessment complete!")
    print("=" * 70)
    
    # Exit with error code if critical/high findings
    if result.summary['critical'] > 0 or result.summary['high'] > 0:
        sys.exit(1)
    
    sys.exit(0)


if __name__ == '__main__':
    main()
