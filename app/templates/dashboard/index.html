{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block page_content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <h1 class="dashboard-welcome">Welcome back, {{ current_user.full_name or current_user.email.split('@')[0] }}!</h1>
    <p class="dashboard-subtitle">Here's what's happening with your portfolio today</p>
</div>

<!-- Dashboard Stats -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-card-label">
            <i data-lucide="wallet" width="16" height="16"></i>
            Wallet Balance
        </div>
        <div class="stat-card-value">${{ "{:,.2f}".format(wallet_balance) }}</div>
        <div class="stat-card-change">
            Available for trading
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-label">
            <i data-lucide="trending-up" width="16" height="16"></i>
            Portfolio Value
        </div>
        <div class="stat-card-value">${{ "{:,.2f}".format(portfolio_value) }}</div>
        <div class="stat-card-change {{ 'positive' if portfolio_change >= 0 else 'negative' }}">
            <i data-lucide="{{ 'arrow-up' if portfolio_change >= 0 else 'arrow-down' }}" width="14" height="14"></i>
            {{ "{:+.2f}".format(portfolio_change) }}%
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-label">
            <i data-lucide="dollar-sign" width="16" height="16"></i>
            Total Worth
        </div>
        <div class="stat-card-value">${{ "{:,.2f}".format(total_worth) }}</div>
        <div class="stat-card-change">
            Wallet + Portfolio
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-label">
            <i data-lucide="percent" width="16" height="16"></i>
            Total Return
        </div>
        <div class="stat-card-value {{ 'text-success' if total_return >= 0 else 'text-danger' }}">
            {{ "{:+.2f}".format(total_return) }}%
        </div>
        <div class="stat-card-change">
            All-time performance
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Predict Section -->
    <div class="col-lg-8 mb-4">
        <div class="dashboard-section">
            <h3 class="dashboard-section-title">
                <i data-lucide="line-chart" width="24" height="24"></i>
                Quick Stock Prediction
            </h3>
            <div class="quick-predict-form">
                <form method="POST" action="{{ url_for('dashboard.predict') }}" id="predictForm">
                    {{ predict_form.hidden_tag() }}
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <div class="form-group mb-0">
                                <label for="symbol" class="form-label">Stock Symbol</label>
                                {{ predict_form.symbol(class="form-control", placeholder="Enter stock symbol (e.g., AAPL, GOOGL)") }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i data-lucide="search" width="18" height="18"></i>
                                Get Prediction
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Top Holdings -->
        <div class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="dashboard-section-title mb-0">
                    <i data-lucide="briefcase" width="24" height="24"></i>
                    Top Holdings
                </h3>
                <a href="{{ url_for('portfolio.index') }}" class="btn btn-sm btn-outline-primary">
                    View All
                    <i data-lucide="arrow-right" width="16" height="16"></i>
                </a>
            </div>
            
            {% if top_holdings %}
                <div class="holdings-preview">
                    {% for holding in top_holdings %}
                        <div class="holding-card">
                            <div class="holding-info">
                                <div class="holding-symbol">{{ holding.symbol }}</div>
                                <div class="holding-name">{{ holding.company_name }}</div>
                                <div class="text-sm text-secondary">{{ holding.quantity }} shares</div>
                            </div>
                            <div class="holding-value">
                                <div class="holding-amount">${{ "{:,.2f}".format(holding.current_value) }}</div>
                                <div class="holding-change {{ 'text-success' if holding.unrealized_gain >= 0 else 'text-danger' }}">
                                    {{ "{:+.2f}".format(holding.unrealized_gain_pct) }}%
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“Š</div>
                    <div class="empty-state-title">No Holdings Yet</div>
                    <div class="empty-state-description">Start building your portfolio by placing your first order</div>
                    <a href="{{ url_for('orders.buy') }}" class="btn btn-primary mt-3">
                        <i data-lucide="plus" width="18" height="18"></i>
                        Place Order
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-4 mb-4">
        <div class="dashboard-section">
            <h3 class="dashboard-section-title">
                <i data-lucide="activity" width="24" height="24"></i>
                Recent Activity
            </h3>
            <div class="activity-timeline">
                {% if recent_transactions %}
                    {% for transaction in recent_transactions %}
                        <div class="activity-item">
                            <div class="activity-icon {{ 'buy' if transaction.transaction_type.value == 'BUY' else 'sell' if transaction.transaction_type.value == 'SELL' else '' }}">
                                {% if transaction.transaction_type.value == 'BUY' %}
                                    <i data-lucide="arrow-down-circle" width="20" height="20"></i>
                                {% elif transaction.transaction_type.value == 'SELL' %}
                                    <i data-lucide="arrow-up-circle" width="20" height="20"></i>
                                {% elif transaction.transaction_type.value == 'DIVIDEND' %}
                                    <i data-lucide="dollar-sign" width="20" height="20"></i>
                                {% elif transaction.transaction_type.value == 'DEPOSIT' %}
                                    <i data-lucide="plus-circle" width="20" height="20"></i>
                                {% elif transaction.transaction_type.value == 'WITHDRAWAL' %}
                                    <i data-lucide="minus-circle" width="20" height="20"></i>
                                {% else %}
                                    <i data-lucide="circle" width="20" height="20"></i>
                                {% endif %}
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">
                                    {% if transaction.transaction_type.value == 'BUY' %}
                                        Bought {{ transaction.company.symbol if transaction.company else 'Stock' }}
                                    {% elif transaction.transaction_type.value == 'SELL' %}
                                        Sold {{ transaction.company.symbol if transaction.company else 'Stock' }}
                                    {% elif transaction.transaction_type.value == 'DIVIDEND' %}
                                        Dividend from {{ transaction.company.symbol if transaction.company else 'Stock' }}
                                    {% elif transaction.transaction_type.value == 'DEPOSIT' %}
                                        Deposited Funds
                                    {% elif transaction.transaction_type.value == 'WITHDRAWAL' %}
                                        Withdrew Funds
                                    {% elif transaction.transaction_type.value == 'FEE' %}
                                        Commission Fee
                                    {% else %}
                                        {{ transaction.transaction_type.value }}
                                    {% endif %}
                                </div>
                                <div class="activity-description">
                                    {{ transaction.description or '' }}
                                </div>
                            </div>
                            <div class="activity-time">
                                <div class="font-medium {{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                    ${{ "{:,.2f}".format(transaction.amount|abs) }}
                                </div>
                                <div class="text-xs text-tertiary">
                                    {{ transaction.created_at.strftime('%b %d') }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <div class="empty-state-title">No Activity</div>
                        <div class="empty-state-description">Your recent transactions will appear here</div>
                    </div>
                {% endif %}
            </div>
            
            {% if recent_transactions %}
                <div class="mt-3 text-center">
                    <a href="{{ url_for('orders.transactions') }}" class="btn btn-sm btn-outline-secondary">
                        View All Transactions
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Quick Actions</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ url_for('orders.buy') }}" class="btn btn-success">
                        <i data-lucide="shopping-cart" width="18" height="18"></i>
                        Buy Stocks
                    </a>
                    <a href="{{ url_for('orders.sell') }}" class="btn btn-danger">
                        <i data-lucide="trending-down" width="18" height="18"></i>
                        Sell Stocks
                    </a>
                    <a href="{{ url_for('portfolio.wallet') }}" class="btn btn-primary">
                        <i data-lucide="wallet" width="18" height="18"></i>
                        Manage Wallet
                    </a>
                    <a href="{{ url_for('reports.index') }}" class="btn btn-secondary">
                        <i data-lucide="file-text" width="18" height="18"></i>
                        View Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        
        // Add stock autocomplete to predict form
        const symbolInput = document.getElementById('symbol');
        if (symbolInput && typeof initStockAutocomplete === 'function') {
            initStockAutocomplete(symbolInput);
        }
    });
</script>
{% endblock %}
